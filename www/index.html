<!--
 Copyright (C) 2020 Ivan Kniazkov

 This file is part of Antcore.

 Antcore is free software: you can redistribute it and/or modify it under the terms of
 the GNU General Public License as published by the Free Software Foundation,
 either version 3 of the License, or (at your option) any later version.

 Antcore is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 See the GNU General Public License for more details.

 You should have received a copy of the GNU General Public License along with Antcore.
 If not, see <http://www.gnu.org/licenses/>.
 -->
<html>
	<head>
		<meta charset="UTF-8">
		<script src="js/lib.js"></script>
		<link href="styles.css" rel="stylesheet">
		<link href="fonts/fonts.css" rel="stylesheet">
	</head>
	<body>
		<script>
			var connection = null;
			var widgets = null;

			var processor = {
				"print" : function(instruction) {
					console.log(instruction.message);
				},

				"create widget" : function(instruction) {
					var widget = null;
					switch(instruction.class) {
						case "label":
							widget = document.createElement("span");
							break;
					}
					if (widget) {
						widgets[instruction.id] = widget;
					}
				},

				"append widget" : function(instruction) {
					var container = widgets[instruction.container];
					var widget = widgets[instruction.widget];
					if (container && widget) {
						container.appendChild(widget);
					}
				},

				"set widget data" : function(instruction) {
					var widget = widgets[instruction.widget];
					if (widget) {
						widget.innerHTML = escapeHtml(instruction.data);
					}
				}
			};

			var initConnection = function() {
				connection = null;
				widgets = {};
				widgets[0] = document.body;
				sendRequestWithData("create instance", { page : "INDEX" }, function(response) {
					var data = JSON.parse(response);
					connection = {
						uid : data.uid,
						transaction : 0,
						processed : []
					};
					var interval = setInterval(function() {
						connection.transaction++;
						sendRequestWithData("update", connection, function(response) {
							data = JSON.parse(response);
							if (data === null) {
								clearInterval(interval);
								initConnection();
							}
							if (data.instructions) {
								connection.processed = [];
								for (var k = 0; k < data.instructions.length; k++) {
									var instruction = data.instructions[k];
									var executor = processor[instruction.type];
									if (executor)
										executor(instruction);
									else
										console.log("Unknown instruction: " + instruction.type);
									connection.processed.push(instruction.uid);
								}
							}
						});
					}, 100);
				});
			};
			initConnection();
		</script>
	</body>
</html>
